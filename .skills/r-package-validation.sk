name: r-package-validation
description: |
  Skill for validating R package changes by running R CMD CHECK to ensure:
  - All unit tests pass
  - Package builds successfully without errors or warnings
  - Code changes don't keep the package from building

context:
  This repository is the merTools R package (version 0.6.4) for analyzing 
  mixed effect regression models. It uses testthat edition 3 for testing 
  with parallel execution enabled.

key-files:
  - DESCRIPTION: Package metadata
  - NAMESPACE: Exported functions (auto-generated by roxygen)
  - R/: Source code directory with 13 .R files
  - tests/: Test directory with testthat tests (testthat-a_m.R, testthat-m_z.R)
  - inst/: Installed package files including shiny apps

validations:
  full-build-check:
    name: Complete Package Build and Check
    description: Full R CMD CHECK to verify package integrity
    priority: high
    steps:
      - Ensure dependencies are installed
      - Build package: R CMD BUILD merTools
      - Check package: R CMD CHECK --no-manual merTools_*.tar.gz
    success-criteria:
      - No ERRORs (0 errors) in check output
      - No WARNINGs (0 warnings) that Block submission to CRAN
      - All unit tests pass in check output (Status: OK)
    failure-actions:
      - If errors found, review build log and fix issues
      - Rebuild after fixes: R CMD BUILD merTools && R CMD CHECK *.tar.gz

  run-tests:
    name: Unit Test Execution
    description: Run testthat test suite to verify code changes
    priority: high
    steps:
      - Install package locally: R CMD INSTALL merTools_*.tar.gz
      - Run tests: Rscript -e "library(testthat); library(merTools); test_package('merTools')"
      - Or: R CMD check --no-manual merTools_*.tar.gz (check tests section)
    success-criteria:
      - All testthat tests pass (no failures or errors in log)
      - Check output shows "Status: OK"
    alternative:
      command: Rscript -e "devtools::test()"
      when: During development with devtools installed

  quick-check:
    name: Quick Development Check
    description: Fast validation for development iterations without full checks
    priority: medium
    steps:
      - Install package: R CMD INSTALL merTools_*.tar.gz
      - Load and basic check: Rscript -e "library(merTools); packageVersion('merTools')"
    success-criteria:
      - Package installs without errors
      - No startup errors when loading package

critical-files:
  build-essential:
    description: Files essential for package building
    files:
      - DESCRIPTION: Must be valid package metadata, no syntax errors
      - NAMESPACE: Must export all functions correctly (auto-generated)
      - R/*.R: Source code files (13 total files listed below)
  test-essential:
    description: Files essential for testing
    files:
      - tests/testthat-a_m.R: Tests for functions A-M (filter = "^[a-m]")
      - tests/testthat-m_z.R: Tests for functions N-Z (filter = "^[m-z]")
  documentation-essential:
    description: Documentation that must be current
    files:
      - man/*.Rd: All function documentation (generated from R source)
  vignette-essential:
    description: Vignettes that may need rebuilding
    files:
      - vignettes/Using_predictInterval.Rmd.orig: Source for predictInterval vignette
      - vignettes/merToolsIntro.Rmd.orig: Source for intro vignette
      - vignettes/marginal_effects.Rmd.orig: Source for marginal effects vignette
      - vignettes/imputation.Rmd.orig: Source for imputation vignette
    note: Vignettes use precompile.R to expand from .orig files

common-issues:
  roxygen-generation:
    description: Roxygen documentation not regenerated after R changes
    symptom: Man files outdated, NAMESPACE missaligned
    solution: Run Rscript -e "devtools::document()" before build
  test-failures:
    description: Tests failing after code changes
    symptom: R CMD CHECK shows test failures
    solution: Run specific tests with devtools::test() to debug
  vignette-build-failure:
    description: Vignettes fail to build during check
    symptom: ERROR or WARNING in vignette rebuilding section
    solution: Check vignettes/precompile.R may need API keys or dependencies
  dependency-issues:
    description: Missing required packages during check
    symptom: ERROR: dependency 'X' is not available
    solution: Install missing dependencies or check DESCRIPTION file

commands:
  build-package:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && R CMD BUILD merTools
    description: Build tar.gz package from source (always run from repo root)
  check-package:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && R CMD CHECK --no-manual merTools_*.tar.gz
    description: Run full package check suite (non-interactive, no manual)
  check-package-verbose:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && R CMD CHECK merTools_*.tar.gz
    description: Run full package check with manual (interactive, for CRAN submission)
  install-local:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && R CMD INSTALL merTools_*.tar.gz
    description: Install package locally for testing (after successful build)
  run-tests-specific:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && Rscript -e "library(testthat); library(merTools); test_file('tests/testthat/YOUR_TEST.R')"
    description: Run specific test file
  document-package:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && Rscript -e "devtools::document()"
    description: Regenerate NAMESPACE and Rd files with roxygen (use after R file changes)
  check-with-cov:
    command: cd /Users/jared/Nextcloud/Civilytics/Code/GitHub/merTools && Rscript -e "covr::package_coverage()"
    description: Run tests with coverage reporting (development only)

verification-steps:
  post-build:
    - Check: ls -la merTools_*.tar.gz exists
    - Verify: tar -tzf merTools_*.tar.gz | head shows expected structure
  post-check:
    - Verify: grep "Status:" merTools.Rcheck/00check.log shows "OK"
    - Check: No "ERROR:" or "WARNING:" lines in check log
  post-install:
    - Verify: Rscript -e "library(merTools); packageVersion('merTools')" shows correct version

branching-guidance:
  - Always run full-build-check before merge to main branch
  - Run quick-check on feature branches during development iterations
  - Run run-tests after any code changes in R/ directory
  - Run document-package before building if modified .R files with roxygen comments
  - Check vignettes build if any .Rmd files modified

existing-workflow:
  location: .github/workflows/check-standard.yaml
  purpose: CI/CD automated checks on GitHub Actions
  schedules:
    - All pushes to any branch (pull_request and push)
    - Tests on: macOS, Windows, Ubuntu (devel, release, oldrel-1)
  coverage: R-CMD-check with GitHub Actions r-lib/actions
  note: Manual checks still required before local commits

development-tools:
  - devtools: For document(), test()
  - covr: For coverage reporting
  - rcmdcheck: Programmatic check execution
